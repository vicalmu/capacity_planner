// main.js - Archivo principal que inicializa la aplicaci√≥n

const NetberryApp = {
    // Estado de la aplicaci√≥n
    state: {
        initialized: false,
        lastUpdate: null,
        autoUpdateEnabled: true
    },

    // Inicializar aplicaci√≥n
    init: function() {
        if (this.state.initialized) return;

        console.log('üöÄ Inicializando Netberry Capacity Planning...');

        // Verificar dependencias
        if (!this.checkDependencies()) {
            console.error('‚ùå Faltan dependencias requeridas');
            return;
        }

        // Inicializar componentes en orden
        try {
            this.initializeComponents();
            this.setupEventListeners();
            this.startAutoUpdate();
            
            this.state.initialized = true;
            this.state.lastUpdate = new Date();
            
            console.log('‚úÖ Netberry Capacity Planning inicializado correctamente');
            
            

        } catch (error) {
            console.error('‚ùå Error al inicializar la aplicaci√≥n:', error);
            this.showErrorMessage(error);
        }
    },

    // Verificar que todas las dependencias est√©n disponibles
    checkDependencies: function() {
        const required = [
            'NetberryData',
            'NetberryUtils', 
            'NetberryComponents',
            'NetberryModal',
            'NetberrySimulator',
            'formatNumber'
        ];

        const missing = required.filter(dep => typeof window[dep] === 'undefined');
        
        if (missing.length > 0) {
            console.error('Dependencias faltantes:', missing);
            return false;
        }

        return true;
    },

    // Inicializar todos los componentes
    initializeComponents: function() {
        console.log('üîß Inicializando componentes...');

        // 1. Inicializar datos (aplicar formato de n√∫meros)
        this.validateDataIntegrity();

        // 2. Inicializar componentes UI
        NetberryComponents.init();

        // 3. Inicializar simulador escalable
        NetberrySimulator.init();

        // 4. Inicializar modal
        NetberryModal.init();

        console.log('‚úÖ Todos los componentes inicializados');
    },

    // Validar integridad de datos y formato de n√∫meros
    validateDataIntegrity: function() {
        console.log('üîç Validando integridad de datos...');

        let issuesFound = 0;

        // Verificar que todos los n√∫meros est√©n formateados correctamente
        Object.values(NetberryData.departments).forEach(dept => {
            // Verificar utilizaci√≥n del departamento
            if (!this.isValidNumber(dept.utilization, 2)) {
                console.warn(`‚ö†Ô∏è Utilizaci√≥n mal formateada en ${dept.name}: ${dept.utilization}`);
                dept.utilization = formatNumber.decimal(dept.utilization);
                issuesFound++;
            }

            // Verificar personas
            dept.people.forEach(person => {
                if (!this.isValidNumber(person.utilization, 2)) {
                    console.warn(`‚ö†Ô∏è Utilizaci√≥n mal formateada para ${person.name}: ${person.utilization}`);
                    person.utilization = formatNumber.decimal(person.utilization);
                    issuesFound++;
                }
            });
        });

        // Verificar proyectos
        NetberryData.projects.forEach(project => {
            if (!this.isValidNumber(project.progress, 2)) {
                console.warn(`‚ö†Ô∏è Progreso mal formateado en ${project.name}: ${project.progress}`);
                project.progress = formatNumber.decimal(project.progress);
                issuesFound++;
            }
        });

        if (issuesFound > 0) {
            console.log(`üîß Se corrigieron ${issuesFound} problemas de formato num√©rico`);
        } else {
            console.log('‚úÖ Todos los n√∫meros est√°n correctamente formateados');
        }
    },

    // Verificar si un n√∫mero tiene el formato correcto
    isValidNumber: function(num, maxDecimals = 2) {
        if (typeof num !== 'number') return false;
        
        const decimals = (num.toString().split('.')[1] || '').length;
        return decimals <= maxDecimals;
    },

    // Configurar event listeners globales
    setupEventListeners: function() {
        console.log('üéß Configurando event listeners...');

        // Resize handler para responsive
        window.addEventListener('resize', NetberryUtils.debounce(() => {
            this.handleResize();
        }, 250));

        // Visibility change para pausar actualizaciones
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                NetberryUtils.autoUpdate.stop();
            } else if (this.state.autoUpdateEnabled) {
                NetberryUtils.autoUpdate.start();
            }
        });

        // Error handler global
        window.addEventListener('error', (event) => {
            console.error('Error global capturado:', event.error);
            this.showErrorMessage(event.error);
        });

        console.log('‚úÖ Event listeners configurados');
    },

    // Manejar cambio de tama√±o de ventana
    handleResize: function() {
        // Reajustar componentes si es necesario
        const isMobile = window.innerWidth <= 768;
        
        if (isMobile) {
            // Configuraci√≥n para m√≥vil
            document.body.classList.add('mobile-view');
        } else {
            document.body.classList.remove('mobile-view');
        }
    },

    // Iniciar auto-actualizaci√≥n
    startAutoUpdate: function() {
        if (this.state.autoUpdateEnabled) {
            NetberryUtils.autoUpdate.start();
            console.log('üîÑ Auto-actualizaci√≥n iniciada (cada 30 segundos)');
        }
    },

    // Mostrar mensaje de error
    showErrorMessage: function(error) {
        const message = error.message || 'Error desconocido en la aplicaci√≥n';
        NetberryUtils.notifications.show(
            `Error: ${message}. Consulta la consola para m√°s detalles.`,
            'error',
            5000
        );
    },

    // M√©todos de utilidad para debug
    debug: {
        // Mostrar estado actual
        showState: function() {
            console.log('üìä Estado actual de Netberry:', {
                initialized: NetberryApp.state.initialized,
                lastUpdate: NetberryApp.state.lastUpdate,
                autoUpdate: NetberryApp.state.autoUpdateEnabled,
                activeFilters: NetberryUtils.activeFilters,
                currentDepartment: NetberryModal.currentDepartment
            });
        },

        // Verificar formato de n√∫meros
        checkNumberFormats: function() {
            console.log('üî¢ Verificando formato de n√∫meros...');
            
            Object.entries(NetberryData.departments).forEach(([key, dept]) => {
                console.log(`${dept.name}: ${dept.utilization}% (${typeof dept.utilization})`);
                
                dept.people.forEach(person => {
                    const decimals = (person.utilization.toString().split('.')[1] || '').length;
                    if (decimals > 2) {
                        console.warn(`‚ùå ${person.name}: ${person.utilization}% (${decimals} decimales)`);
                    }
                });
            });
        },

        // Simular datos de prueba
        simulateData: function() {
            console.log('üß™ Simulando datos de prueba...');
            
            // Cambiar algunas utilizaciones para probar
            Object.values(NetberryData.departments).forEach(dept => {
                const oldUtil = dept.utilization;
                dept.utilization = formatNumber.decimal(Math.random() * 100);
                console.log(`${dept.name}: ${oldUtil}% ‚Üí ${dept.utilization}%`);
            });
            
            // Actualizar UI
            NetberryComponents.updateAll();
            
            NetberryUtils.notifications.show('Datos de prueba aplicados', 'info');
        },

        // Resetear datos originales
        resetData: function() {
            location.reload();
        }
    },

    // M√©todos p√∫blicos para control de la aplicaci√≥n
    toggleAutoUpdate: function() {
        this.state.autoUpdateEnabled = !this.state.autoUpdateEnabled;
        
        if (this.state.autoUpdateEnabled) {
            NetberryUtils.autoUpdate.start();
            NetberryUtils.notifications.show('Auto-actualizaci√≥n activada', 'success');
        } else {
            NetberryUtils.autoUpdate.stop();
            NetberryUtils.notifications.show('Auto-actualizaci√≥n desactivada', 'info');
        }
    },

    // Forzar actualizaci√≥n manual
    forceUpdate: function() {
        console.log('üîÑ Forzando actualizaci√≥n manual...');
        NetberryComponents.updateAll();
        this.state.lastUpdate = new Date();
        NetberryUtils.notifications.show('Dashboard actualizado manualmente', 'success');
    },

    // Exportar datos completos
    exportAllData: function() {
        const exportData = {
            timestamp: new Date().toISOString(),
            departments: NetberryData.departments,
            projects: NetberryData.projects,
            activeFilters: NetberryUtils.activeFilters,
            summary: {
                totalCapacity: NetberryData.calculations.getTotalCapacity(),
                averageUtilization: NetberryData.calculations.getAverageUtilization(),
                criticalDepartments: NetberryData.calculations.getCriticalDepartments()
            }
        };

        NetberryUtils.export.toJSON(exportData, 'netberry_dashboard_complete.json');
        NetberryUtils.notifications.show('Datos completos exportados', 'success');
    }
};

// Auto-inicializar cuando el DOM est√© listo
document.addEventListener('DOMContentLoaded', function() {
    // Peque√±o delay para asegurar que todos los scripts est√©n cargados
    setTimeout(() => {
        NetberryApp.init();
    }, 100);
});

// Exponer funciones √∫tiles globalmente para debug
window.Netberry = {
    app: NetberryApp,
    debug: NetberryApp.debug,
    forceUpdate: () => NetberryApp.forceUpdate(),
    toggleAutoUpdate: () => NetberryApp.toggleAutoUpdate(),
    exportData: () => NetberryApp.exportAllData()
};

// Mensaje de consola para desarrolladores
console.log(`
üß° Netberry Capacity Planning Dashboard
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Funciones disponibles en consola:
‚Ä¢ Netberry.debug.showState() - Ver estado actual
‚Ä¢ Netberry.debug.checkNumberFormats() - Verificar decimales
‚Ä¢ Netberry.forceUpdate() - Actualizar manualmente
‚Ä¢ Netberry.toggleAutoUpdate() - Activar/desactivar auto-actualizaci√≥n
‚Ä¢ Netberry.exportData() - Exportar todos los datos

Atajos de teclado:
‚Ä¢ ESC - Cerrar modal
‚Ä¢ Ctrl+F - Enfocar filtros
‚Ä¢ Ctrl+S - Simular proyecto
‚Ä¢ Ctrl+R - Resetear filtros
‚Ä¢ ‚Üê ‚Üí - Navegar entre departamentos en modal
‚Ä¢ Ctrl+E - Exportar datos del departamento

üîß Bugs solucionados:
‚úÖ N√∫meros limitados a 2 decimales m√°ximo
‚úÖ Simulador escalable para N departamentos
‚úÖ Arquitectura modular optimizada

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
`);

// Exportar para uso global
window.NetberryApp = NetberryApp;