<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Capacity Planner Netberry - Modo Gantt</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/mode_styles.css">
</head>
<body>
    <!-- Alert Banner (condicional) -->
    <div class="alert-banner" id="alertBanner">
        üö® ATENCI√ìN: DevOps al 94.7% de capacidad - Acci√≥n requerida
    </div>

    <!-- üéØ HEADER LIMPIO Y FUNCIONAL -->
    <div class="header gantt-mode smart-header">
        <div class="header-content-smart">
            <!-- Logo y navegaci√≥n -->
            <div class="header-brand">
                <button class="back-home-icon" onclick="goHome()" title="Volver al inicio">üè†</button>
                <h1>Netberry</h1>
            </div>
            
            <!-- Indicadores Health + Alerts -->
            <div class="header-indicators">
                <div class="health-compact">
                    <span class="health-number-compact" id="healthCompact">87</span>
                    <span class="health-label-compact">Health</span>
                </div>
                <div class="alerts-compact">
                    <span class="alerts-number-compact" id="alertsCompact">3</span>
                    <span class="alerts-label-compact">Cr√≠ticas</span>
                </div>
            </div>
            
            <!-- KPIs compactos inline -->
            <div class="kpi-header-compact" id="kpiHeaderCompact">
                <div class="kpi-compact" style="border-left-color: #10b981">
                    <div class="kpi-value-compact">4.2k</div>
                    <div class="kpi-label-compact">Disponible</div>
                </div>
                <div class="kpi-compact" style="border-left-color: #ef4444">
                    <div class="kpi-value-compact">3</div>
                    <div class="kpi-label-compact">Cr√≠ticos</div>
                </div>
                <div class="kpi-compact" style="border-left-color: #3b82f6">
                    <div class="kpi-value-compact">12</div>
                    <div class="kpi-label-compact">Proyectos</div>
                </div>
            </div>
            
            <!-- Selector de modos -->
            <div class="mode-selector">
                <button class="current-mode-btn" onclick="toggleModeMenu()">
                    <span class="mode-icon">üìä</span>
                    <span class="mode-name">Modo Gantt</span>
                    <span class="mode-arrow">‚ñº</span>
                </button>
                <div class="mode-menu" id="modeMenu">
                    <div class="mode-option active" data-mode="gantt">
                        <span class="mode-icon">üìä</span>
                        <span>Modo Gantt</span>
                        <span class="check">‚úì</span>
                    </div>
                    <div class="mode-option" data-mode="projects" onclick="switchMode('projects')">
                        <span class="mode-icon">üìã</span>
                        <span>Modo Proyectos</span>
                    </div>
                    <div class="mode-option" data-mode="simulator" onclick="switchMode('simulator')">
                        <span class="mode-icon">‚ö°</span>
                        <span>Modo Simulador</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- üéØ DASHBOARD MAXIMIZADO - GANTT PROTAGONISTA -->
    <div class="dashboard-maximized">
        <!-- Gantt Chart Fusionado -->
        <div class="gantt-container-maximized">
            
            <div class="gantt-chart" id="ganttChart">
                <!-- El Gantt fusionado se genera din√°micamente -->
                <div class="gantt-loading">
                    <div>‚è≥ Cargando diagrama Gantt...</div>
                </div>
            </div>
            
            <div class="gantt-legend-compact" id="ganttLegend">
                <!-- Leyenda compacta se genera din√°micamente -->
            </div>
        </div>

        <!-- AI Recommendations - Compactas al pie -->
        <div class="ai-recommendations-footer" id="aiRecommendations">
            <div class="recommendations-header-compact">
                <h3>ü§ñ Recomendaciones Inteligentes</h3>
                <div class="ai-confidence-compact">Confianza: 94%</div>
            </div>
            <div class="recommendations-carousel" id="recommendationsCarousel">
                <div class="recommendation-card">
                    <div class="recommendation-content">
                        <span class="recommendation-icon">üîÑ</span>
                        <span class="recommendation-text">Mover 120h del proyecto E-commerce de PHP a .NET reducir√≠a riesgo general un 15%</span>
                    </div>
                    <button class="recommendation-action" onclick="console.log('Aplicar recomendaci√≥n')">Aplicar</button>
                </div>
                <div class="recommendation-card">
                    <div class="recommendation-content">
                        <span class="recommendation-icon">üë•</span>
                        <span class="recommendation-text">Contratar 1 DevOps Senior incrementar√≠a capacidad global un 12%</span>
                    </div>
                    <button class="recommendation-action" onclick="console.log('Ver ROI')">Ver ROI</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modales mantenidos -->
    <div id="departmentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close-modal" onclick="NetberryModal.close()">&times;</span>
                <h2 id="modalTitle">Detalle del Departamento</h2>
                <p id="modalSubtitle">Vista detallada de recursos</p>
            </div>
            <div class="modal-body">
                <div class="stats-grid" id="modalStats"></div>
                <h3>üë• Equipo y Asignaciones</h3>
                <div class="people-grid" id="peopleGrid"></div>
            </div>
        </div>
    </div>

    <div id="simulatorModal" class="modal">
        <div class="modal-content simulator-modal-content">
            <div class="modal-header">
                <span class="close-modal" onclick="NetberryComponents.simulator.closeModal()">&times;</span>
                <h2>üéØ Simulador de Impacto de Proyectos</h2>
                <p>Eval√∫a la viabilidad y el impacto de nuevos proyectos</p>
            </div>
            <div class="modal-body">
                <div id="simulatorModalContent"></div>
            </div>
        </div>
    </div>

    <div id="projectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close-modal" onclick="GanttChart.closeProjectModal()">&times;</span>
                <h2 id="projectModalTitle">Detalles del Proyecto</h2>
                <p id="projectModalSubtitle">Informaci√≥n del proyecto</p>
            </div>
            <div class="modal-body">
                <div id="projectModalContent"></div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <!-- Core dependencies -->
    <script src="js/data.js"></script>
    <script src="js/utils.js"></script>
    
    <!-- Components and controllers -->
    <script src="js/components_main.js"></script>
    <script src="js/gantt/gantt_chart.js"></script>
    <script src="js/gantt/gantt_controller.js"></script>
    <script src="js/simulator/simulator_domino.js"></script>

    <script>
        // Variables globales
        let selectedDepartments = ['php', 'dotnet', 'devops', 'movilidad', 'ux', 'pmo', 'marketing', 'qa'];

        // Funciones del dropdown de departamentos - CORREGIDAS
        function toggleDepartmentDropdown() {
            const dropdown = document.getElementById('selectorDropdown');
            if (dropdown) {
                dropdown.classList.toggle('show');
                
                // Actualizar flecha
                const toggle = document.getElementById('departmentToggle');
                const arrow = toggle?.querySelector('.arrow');
                if (arrow) {
                    arrow.style.transform = dropdown.classList.contains('show') ? 'rotate(180deg)' : 'rotate(0deg)';
                }
            }
        }

        function selectAllDepartments() {
            console.log('üîÑ Seleccionando todos los departamentos...');
            
            // M√©todo 1: Si GanttChart est√° disponible
            if (typeof GanttChart !== 'undefined' && GanttChart.selectAllDepartments) {
                GanttChart.selectAllDepartments();
                return;
            }
            
            // M√©todo 2: Fallback manual
            const checkboxes = document.querySelectorAll('#selectorDropdown input[type="checkbox"]');
            checkboxes.forEach(cb => {
                cb.checked = true;
                const optionItem = cb.closest('.option-item');
                if (optionItem) {
                    optionItem.classList.add('selected');
                }
            });
            
            selectedDepartments = Array.from(checkboxes).map(cb => cb.value);
            updateSelectorDisplay();
            applyFilters();
        }

        function clearAllDepartments() {
            console.log('üßπ Limpiando selecci√≥n de departamentos...');
            
            // M√©todo 1: Si GanttChart est√° disponible
            if (typeof GanttChart !== 'undefined' && GanttChart.clearAllDepartments) {
                GanttChart.clearAllDepartments();
                return;
            }
            
            // M√©todo 2: Fallback manual
            const checkboxes = document.querySelectorAll('#selectorDropdown input[type="checkbox"]');
            checkboxes.forEach(cb => {
                cb.checked = false;
                const optionItem = cb.closest('.option-item');
                if (optionItem) {
                    optionItem.classList.remove('selected');
                }
            });
            
            selectedDepartments = [];
            updateSelectorDisplay();
            applyFilters();
        }

        function updateSelectorDisplay() {
            const toggle = document.getElementById('selectedCount');
            if (!toggle) return;
            
            const count = selectedDepartments.length;
            
            if (count === 0) {
                toggle.textContent = 'Ninguno';
            } else if (count === 8) {
                toggle.textContent = 'Todos (8)';
            } else {
                toggle.textContent = `${count} seleccionados`;
            }
            
            // Actualizar checkmarks visuales
            document.querySelectorAll('.option-item').forEach(item => {
                const checkbox = item.querySelector('input[type="checkbox"]');
                const checkmark = item.querySelector('.checkmark');
                if (checkbox && checkbox.checked) {
                    item.classList.add('selected');
                    if (checkmark) checkmark.style.opacity = '1';
                } else {
                    item.classList.remove('selected');
                    if (checkmark) checkmark.style.opacity = '0';
                }
            });
        }

    function toggleModeMenu() {
    const modeMenu = document.getElementById('modeMenu');
    const isShowing = modeMenu.classList.contains('show');
    
    if (!isShowing) {
        // ABRIR: Calcular posici√≥n del bot√≥n y posicionar dropdown
        const button = document.querySelector('.current-mode-btn');
        const buttonRect = button.getBoundingClientRect();
        
        modeMenu.style.cssText = `
            position: fixed !important;
            top: ${buttonRect.bottom + 8}px !important;
            left: ${buttonRect.right - 200}px !important;
            z-index: 999999 !important;
            background: white !important;
            color: black !important;
            opacity: 1 !important;
            visibility: visible !important;
            display: block !important;
            width: 200px !important;
            border: 1px solid #e2e8f0 !important;
            border-radius: 12px !important;
            transform: none !important;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3) !important;
        `;
        modeMenu.classList.add('show');
    } else {
        // CERRAR
        modeMenu.classList.remove('show');
        modeMenu.style.display = 'none';
    }
}

// Reposicionar al redimensionar ventana
window.addEventListener('resize', function() {
    const modeMenu = document.getElementById('modeMenu');
    if (modeMenu.classList.contains('show')) {
        // Si est√° abierto, recalcular posici√≥n
        const button = document.querySelector('.current-mode-btn');
        const buttonRect = button.getBoundingClientRect();
        
        modeMenu.style.top = `${buttonRect.bottom + 8}px`;
        modeMenu.style.left = `${buttonRect.right - 200}px`;
    }
});

        function switchMode(mode) {
            const modes = {
                'projects': 'projects.html',
                'simulator': 'simulator.html',
                'gantt': 'gantt.html'
            };
            
            if (modes[mode]) {
                window.location.href = modes[mode];
            }
        }

        function goHome() {
            window.location.href = 'index.html';
        }

        // NUEVAS FUNCIONES PARA A√ëO Y VISTA
        function updateYear() {
            const yearSelector = document.getElementById('ganttYearSelector');
            if (!yearSelector) return;
            
            const selectedYear = parseInt(yearSelector.value);
            console.log('üìÖ A√±o cambiado a:', selectedYear);
            
            // Actualizar configuraci√≥n
            if (typeof NetberryData !== 'undefined' && NetberryData.config) {
                NetberryData.config.ganttYear = selectedYear;
            }
            
            // Re-renderizar Gantt
            if (typeof GanttChart !== 'undefined' && GanttChart.render) {
                GanttChart.render();
            }
        }

        function changeView(viewType) {
            console.log('üëÄ Vista cambiada a:', viewType);
            
            // Actualizar botones activos
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const activeBtn = document.querySelector(`[data-view="${viewType}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
            }
            
            // Actualizar configuraci√≥n
            if (typeof NetberryData !== 'undefined' && NetberryData.config) {
                NetberryData.config.ganttView = viewType;
            }
            
            // Re-renderizar Gantt
            if (typeof GanttChart !== 'undefined' && GanttChart.render) {
                GanttChart.render();
            }
        }

        function applyFilters() {
            console.log('üîÑ Aplicando filtros:', selectedDepartments);
            
            // Actualizar NetberryUtils si existe
            if (typeof NetberryUtils !== 'undefined') {
                NetberryUtils.activeFilters = selectedDepartments.length === 8 ? ['all'] : selectedDepartments;
            }
            
            // Actualizar componentes
            if (typeof NetberryComponents !== 'undefined' && NetberryComponents.updateAll) {
                NetberryComponents.updateAll();
            }
            
            // Re-renderizar Gantt
            if (typeof GanttChart !== 'undefined' && GanttChart.render) {
                GanttChart.render();
            }
        }

        // Event listeners
        document.addEventListener('click', function(e) {
            // Cerrar dropdown de departamentos si se hace click fuera
            if (!e.target.closest('.department-selector-inline')) {
                const dropdown = document.getElementById('selectorDropdown');
                if (dropdown && dropdown.classList.contains('show')) {
                    dropdown.classList.remove('show');
                    const toggle = document.getElementById('departmentToggle');
                    const arrow = toggle?.querySelector('.arrow');
                    if (arrow) arrow.style.transform = 'rotate(0deg)';
                }
            }
            
            // Cerrar menu de modos si se hace click fuera
            if (!e.target.closest('.mode-selector')) {
                const modeMenu = document.getElementById('modeMenu');
                if (modeMenu) {
                    modeMenu.classList.remove('show');
                }
            }
        });

        // Manejar clicks en checkboxes de departamentos
        document.addEventListener('change', function(e) {
            if (e.target.type === 'checkbox' && e.target.closest('#selectorDropdown')) {
                const value = e.target.value;
                if (e.target.checked) {
                    if (!selectedDepartments.includes(value)) {
                        selectedDepartments.push(value);
                    }
                } else {
                    selectedDepartments = selectedDepartments.filter(dept => dept !== value);
                }
                updateSelectorDisplay();
                applyFilters();
            }
        });

        // Inicializaci√≥n completa
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üéØ Inicializando Gantt Mode...');
            
            // Crear objetos globales si no existen
            if (typeof NetberryUtils === 'undefined') {
                window.NetberryUtils = {
                    activeFilters: ['all']
                };
            }
            
            if (typeof NetberryData === 'undefined') {
                console.warn('‚ö†Ô∏è NetberryData no encontrado. Aseg√∫rate de cargar data.js');
                return;
            }
            
            // Asegurar configuraci√≥n del Gantt
            if (!NetberryData.config) {
                NetberryData.config = {};
            }
            
            if (!NetberryData.config.ganttYear) {
                NetberryData.config.ganttYear = new Date().getFullYear();
            }
            
            if (!NetberryData.config.ganttView) {
                NetberryData.config.ganttView = 'annual';
            }
            
            if (!NetberryData.config.selectedQuarter) {
                NetberryData.config.selectedQuarter = 'Q1';
            }

            // Sistema de inicializaci√≥n con retry
            const GanttInitializer = {
                maxRetries: 5,
                retryDelay: 200,
                retryCount: 0,
                
                // Verificar dependencias con logs detallados
                checkDependencies() {
                    const dependencies = {
                        'NetberryData': window.NetberryData,
                        'NetberryUtils': window.NetberryUtils,
                        'NetberryComponents': window.NetberryComponents,
                        'GanttChart': window.GanttChart,
                        'GanttMode': window.GanttMode
                    };
                    
                    console.log('üîç Verificando dependencias...');
                    
                    const missing = [];
                    for (const [name, dep] of Object.entries(dependencies)) {
                        if (!dep) {
                            missing.push(name);
                            console.warn(`‚ö†Ô∏è ${name} no est√° disponible`);
                        } else {
                            console.log(`‚úÖ ${name} est√° cargado`);
                        }
                    }
                    
                    if (missing.length > 0) {
                        console.warn(`‚ùå Dependencias faltantes: ${missing.join(', ')}`);
                        return false;
                    }
                    
                    return true;
                },
                
                // Inicializaci√≥n con manejo de errores mejorado
                async initialize() {
                    try {
                        console.log(`üîÑ Intento de inicializaci√≥n #${this.retryCount + 1}`);
                        
                        // Verificar dependencias
                        if (!this.checkDependencies()) {
                            throw new Error('Dependencias incompletas');
                        }
                        
                        // Asegurar que el contenedor existe
                        const container = document.getElementById('ganttChart');
                        if (!container) {
                            throw new Error('Contenedor del Gantt no encontrado');
                        }
                        
                        // Inicializar componentes en orden
                        console.log('1Ô∏è‚É£ Inicializando NetberryComponents...');
                        await this.safeInitialize(() => NetberryComponents.init());
                        
                        console.log('2Ô∏è‚É£ Renderizando GanttChart...');
                        await this.safeInitialize(() => GanttChart.render());
                        
                        console.log('3Ô∏è‚É£ Inicializando GanttMode...');
                        await this.safeInitialize(() => GanttMode.init());
                        
                        console.log('4Ô∏è‚É£ Actualizando selector...');
                        updateSelectorDisplay();
                        
                        console.log('‚úÖ Inicializaci√≥n completada con √©xito');
                        return true;
                        
                    } catch (error) {
                        console.error(`‚ùå Error en intento #${this.retryCount + 1}:`, error);
                        
                        if (this.retryCount < this.maxRetries) {
                            this.retryCount++;
                            console.log(`‚è≥ Reintentando en ${this.retryDelay}ms...`);
                            await new Promise(resolve => setTimeout(resolve, this.retryDelay));
                            return this.initialize();
                        } else {
                            this.showError(error);
                            return false;
                        }
                    }
                },
                
                // Inicializaci√≥n segura de componentes
                async safeInitialize(initFn) {
                    try {
                        const result = initFn();
                        if (result instanceof Promise) {
                            await result;
                        }
                    } catch (error) {
                        console.error('Error en inicializaci√≥n:', error);
                        throw error;
                    }
                },
                
                // Mostrar error en la UI
                showError(error) {
                    console.error('‚ùå Error fatal despu√©s de', this.maxRetries, 'intentos:', error);
                    
                    const container = document.getElementById('ganttChart');
                    if (container) {
                        container.innerHTML = `
                            <div style="text-align: center; padding: 40px; color: #ef4444;">
                                <h3>‚ùå Error de Inicializaci√≥n</h3>
                                <p>No se pudo inicializar despu√©s de ${this.maxRetries} intentos.</p>
                                <p>Error: ${error.message}</p>
                                <button onclick="location.reload()" style="margin-top: 20px; padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                    üîÑ Recargar P√°gina
                                </button>
                            </div>
                        `;
                    }
                }
            };

            // Iniciar el proceso cuando el DOM est√© listo
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => GanttInitializer.initialize());
            } else {
                GanttInitializer.initialize();
            }
        });

        // Funciones de debug
        window.debugGantt = function() {
            console.log('üîç Debug Info:');
            console.log('- NetberryData:', typeof NetberryData !== 'undefined' ? 'OK' : 'MISSING');
            console.log('- NetberryUtils:', typeof NetberryUtils !== 'undefined' ? 'OK' : 'MISSING');
            console.log('- NetberryComponents:', typeof NetberryComponents !== 'undefined' ? 'OK' : 'MISSING');
            console.log('- GanttChart:', typeof GanttChart !== 'undefined' ? 'OK' : 'MISSING');
            console.log('- GanttMode:', typeof GanttMode !== 'undefined' ? 'OK' : 'MISSING');
            console.log('- selectedDepartments:', selectedDepartments);
            
            if (typeof NetberryUtils !== 'undefined') {
                console.log('- activeFilters:', NetberryUtils.activeFilters);
            }
        };
    </script>
</body>
</html>